# é›»å•†è½‰ç›¤æŠ½çç³»çµ±

> ä¸€å€‹åŸºæ–¼ Spring Boot 3.2 çš„ä¼æ¥­ç´šé«˜ä½µç™¼åˆ†æ•£å¼æŠ½çç³»çµ±ï¼Œå®Œå…¨ç¬¦åˆé›»å•†å¹³å°çš„é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€é«˜ä¸€è‡´æ€§éœ€æ±‚ã€‚

## ğŸ“‹ ç›®éŒ„

- [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [é …ç›®çµæ§‹](#é …ç›®çµæ§‹)
- [æŠ€è¡“](#æŠ€è¡“)
- [ç’°å¢ƒè¦æ±‚](#ç’°å¢ƒè¦æ±‚)
- [API æ–‡æª”](#api-æ–‡æª”)
- [æ ¸å¿ƒå¯¦ç¾](#æ ¸å¿ƒå¯¦ç¾)
- [æ•¸æ“šåº«è¨­è¨ˆ](#æ•¸æ“šåº«è¨­è¨ˆ)
- [æ¸¬è©¦](#æ¸¬è©¦)
- [é™æµç­–ç•¥](#é™æµç­–ç•¥)

---

## ç³»çµ±æ¦‚è¿°

è©²ç³»çµ±æ˜¯ä¸€å€‹å®Œæ•´çš„é›»å•†è½‰ç›¤æŠ½çè§£æ±ºæ–¹æ¡ˆï¼Œæ”¯æŒï¼š

-  **å¤šçå“é…ç½®**ï¼šæ”¯æŒ N ç¨®çå“ï¼Œæ¯ç¨®çå“å¯ç¨ç«‹è¨­å®šåº«å­˜å’Œä¸­çæ©Ÿç‡
-  **ç²¾æº–æ§åˆ¶**ï¼šç¢ºä¿æ‰€æœ‰çå“æ©Ÿç‡ç¸½å’Œç‚º 100%ï¼ˆå«éŠ˜è¬æƒ é¡§ï¼‰
-  **æŠ½ç**ï¼šæ”¯æŒå–®æ¬¡/å¤šæ¬¡é€£çºŒæŠ½çï¼Œæ¯å€‹æ´»å‹•å¯è‡ªè¨‚æ¬¡æ•¸é™åˆ¶ï¼ˆTOTAL/DAILY/WEEKLYï¼‰
- ï¸**é¢¨æ§é˜²è­·**ï¼šæ¡ç”¨ä¸‰å±¤é˜²è­·ï¼ˆåˆ†ä½ˆå¼é– + æ‚²è§€é– + äº‹å‹™ï¼‰ï¼Œ100% é˜²æ­¢é‡è¤‡æŠ½çå’Œåº«å­˜è¶…æŠ½
-  **é«˜ä½µç™¼**ï¼šå³°å€¼æ”¯æŒ 1000+ QPS
-  **åˆ†æ•£å¼éƒ¨ç½²**ï¼šæ”¯æŒæ°´å¹³æ“´å±•ï¼Œå¤šå¯¦ä¾‹ç„¡ç‹€æ…‹é‹è¡Œ
-  **é™æµ**ï¼šæ”¯æŒå…¨å±€é™æµå’Œç”¨æˆ¶ç¶­åº¦é™æµï¼Œé˜²æ­¢ç³»çµ±éè¼‰

---

## æ ¸å¿ƒç‰¹æ€§

### åŠŸèƒ½ç‰¹æ€§

âœ… **ç”¨æˆ¶æŠ½çåŠŸèƒ½**
- å–®æ¬¡æˆ–å¤šæ¬¡é€£çºŒæŠ½ç
- æ”¯æŒä¸‰ç¨®é™åˆ¶æ¨¡å¼ï¼šTOTALï¼ˆç¸½æ¬¡æ•¸ï¼‰ã€DAILYï¼ˆæ¯æ—¥ï¼‰ã€WEEKLYï¼ˆæ¯é€±ï¼‰
- å¯¦æ™‚åº«å­˜æ‰£æ¸›ï¼Œåº«å­˜ä¸è¶³è‡ªå‹•é™ç´šç‚ºéŠ˜è¬æƒ é¡§
- å®Œæ•´çš„æŠ½çæ­·å²è¨˜éŒ„
- å¯¦æ™‚è¿”å›æŠ½ççµæœ

âœ… **ç”¨æˆ¶èªè­‰**
- JWT Token ç„¡ç‹€æ…‹èªè­‰
- æ”¯æŒ Refresh Token åˆ·æ–°
- ç™»å‡ºæ™‚ç«‹å³å¤±æ•ˆ
- åŸºæ–¼è§’è‰²çš„è¨ªå•æ§åˆ¶

âœ… **æ´»å‹•ç®¡ç†**
- æŸ¥è©¢æ´»å‹•åˆ—è¡¨
- æŸ¥è©¢æ´»å‹•è©³æƒ…å’Œçå“ä¿¡æ¯
- å¯¦æ™‚æ´»å‹•ç‹€æ…‹åˆ¤æ–·

âœ… **æ•¸æ“šçµ±è¨ˆ**
- å¯¦æ™‚çµ±è¨ˆç”¨æˆ¶æŠ½çæ¬¡æ•¸å’Œä¸­çæƒ…æ³
- æ´»å‹•ç´šåˆ¥çš„èšåˆçµ±è¨ˆ
- Redis å¿«å–åŠ é€Ÿ

### éåŠŸèƒ½ç‰¹æ€§

âœ… **é«˜å¯ç”¨æ€§**
- åˆ†ä½ˆå¼é–ï¼ˆRedissonï¼‰é˜²æ­¢ä½µç™¼é‡è¤‡æŠ½ç
- æ•¸æ“šåº«æ‚²è§€é–é˜²æ­¢åº«å­˜è¶…æŠ½
- å®Œæ•´çš„ç•°å¸¸è™•ç†å’Œé™ç´šç­–ç•¥

âœ… **é«˜æ€§èƒ½**
- Redis å¤šå±¤ç·©å­˜å„ªåŒ–ç†±æ•¸æ“š
- HikariCP é€£ç·šæ± ç®¡ç†
- AOP è¨»è§£æ–¹å¼çš„é™æµæ§åˆ¶

âœ… **å¯é æ€§**
- å®Œæ•´çš„äº‹å‹™ç®¡ç†ï¼ˆ@Transactionalï¼‰
- çµ±è¨ˆè¡¨é›™å¯«ä¿è­‰æœ€çµ‚ä¸€è‡´æ€§
- è©³ç´°çš„æ“ä½œæ—¥èªŒè¨˜éŒ„

---

## é …ç›®çµæ§‹

```
AmwayEC-Testing/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/org/amway/
â”‚   â”‚   â”‚   â”œâ”€â”€ annotation/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ RateLimit.java                # é™æµè¨»è§£
â”‚   â”‚   â”‚   â”œâ”€â”€ aspect/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ RateLimitAspect.java          # é™æµ AOP åˆ‡é¢
â”‚   â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RateLimiterConfig.java        # é™æµé…ç½®
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RedisConfig.java              # Redis é…ç½®
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SecurityConfig.java           # Spring Security é…ç½®
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SwaggerConfig.java            # Swagger/OpenAPI é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ActivityController.java       # æ´»å‹•æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AuthController.java           # èªè­‰æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ LotteryController.java        # ç”¨æˆ¶æŠ½çæ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DrawRequest.java
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LoginRequest.java
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ RefreshTokenRequest.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ response/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ActivityResponse.java
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ApiResponse.java
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ DrawResponse.java
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ DrawResult.java
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ PrizeResponse.java
â”‚   â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DrawRecord.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LotteryActivity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Prize.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ User.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserDailyDrawStatistics.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserDrawStatistics.java
â”‚   â”‚   â”‚   â”œâ”€â”€ exception/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ enums/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ErrorCode.java            # éŒ¯èª¤ä»£ç¢¼æšèˆ‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ response/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ErrorResponse.java        # éŒ¯èª¤éŸ¿æ‡‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BusinessException.java        # æ¥­å‹™ç•°å¸¸
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GlobalExceptionHandler.java   # å…¨å±€ç•°å¸¸è™•ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DrawRecordRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LotteryActivityRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PrizeRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserDailyDrawStatisticsRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserDrawStatisticsRepository.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserRepository.java
â”‚   â”‚   â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ JwtAuthenticationFilter.java  # JWT éæ¿¾å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ JwtUtil.java                  # JWT å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ActivityService.java          # æ´»å‹•æœå‹™
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ LotteryService.java           # æŠ½çæ ¸å¿ƒæœå‹™
â”‚   â”‚   â”‚   â””â”€â”€ LotteryApplication.java           # Spring Boot å…¥å£
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.yml                   # æ‡‰ç”¨é…ç½®
â”‚   â”‚       â””â”€â”€ application-test.yml              # æ¸¬è©¦é…ç½®
â”‚   â””â”€â”€ test/
â”‚       â”œâ”€â”€ java/org/amway/service/
â”‚       â”‚   â”œâ”€â”€ LotteryServiceIntegrationTest.java # æ•´åˆæ¸¬è©¦
â”‚       â”‚   â””â”€â”€ LotteryServiceTest.java           # å–®å…ƒæ¸¬è©¦
â”‚       â””â”€â”€ resources/
â”‚           â””â”€â”€ application-test.yml              # æ¸¬è©¦é…ç½®
â”œâ”€â”€ build.gradle.kts                              # Gradle æ§‹å»ºé…ç½®
â”œâ”€â”€ schema.sql                                     # æ•¸æ“šåº«åˆå§‹åŒ–è…³æœ¬
â”œâ”€â”€ README.md                                     # æœ¬æ–‡ä»¶                            # æŠ€è¡“æ¶æ§‹è©³è§£
â””â”€â”€ .gitignore
```

---

## æŠ€è¡“

| å±¤ç´š | æŠ€è¡“ | ç‰ˆæœ¬ | ç”¨é€” |
|------|-----|------|------|
| æ¡†æ¶ | Spring Boot | 3.2.0 | Web æ‡‰ç”¨æ¡†æ¶ |
| èªè¨€ | Java | 17+ | ç·¨ç¨‹èªè¨€ |
| æ•¸æ“šåº« | MySQL | 8.0+ | æŒä¹…åŒ–å­˜å„² |
| å¿«å– | Redis + Redisson | 6.0+ | åˆ†ä½ˆå¼é–ã€ç·©å­˜ |
| èªè­‰ | JWT | 0.11.5 | Token èªè­‰ |
| API | SpringDoc OpenAPI | 2.3.0 | API æ–‡æª” |
| ORM | Spring Data JPA + Hibernate | 3.2.0 | æ•¸æ“šåº«è¨ªå• |
| é™æµ | Guava RateLimiter | 32.1.3 | é™æµæ§åˆ¶ |
| æ¸¬è©¦ | JUnit 5 + Mockito | 5.10.0 | å–®å…ƒå’Œæ•´åˆæ¸¬è©¦ |
| AOP | Spring AOP | 3.2.0 | åˆ‡é¢ç·¨ç¨‹ï¼ˆé™æµï¼‰ |
| æ§‹å»º | Gradle | 8.x | é …ç›®æ§‹å»º |

---

## ç’°å¢ƒè¦æ±‚

- JDK 17+
- Gradle 8.x
- MySQL 8.0+
- Redis 6.0+

## API æ–‡æª”

### èªè­‰ç›¸é—œ

#### ç”¨æˆ¶ç™»å…¥

```http
POST /api/auth/login #ç™»å…¥
POST /api/auth/refresh #åˆ·æ–° Token
POST /api/auth/logout #ç™»å‡º
POST /api/lottery/draw #åŸ·è¡ŒæŠ½çï¼ˆæ”¯æŒé™æµï¼‰
GET /api/lottery/history?activityId=1&page=0&size=10 #æŸ¥è©¢æŠ½çæ­·å²
GET /api/lottery/remaining-draws?activityId=1 #æŸ¥è©¢å‰©é¤˜æŠ½çæ¬¡æ•¸
GET /api/activities?page=0&size=10 #æŸ¥è©¢æ´»å‹•åˆ—è¡¨
GET /api/activities/1 #æŸ¥è©¢æ´»å‹•è©³æƒ…
```

**å®Œæ•´ API æ–‡æª”è«‹è¨ªå• Swagger UIï¼š** `http://localhost:8080/swagger-ui.html`

## æ ¸å¿ƒå¯¦ç¾

### æŠ½çæ ¸å¿ƒç®—æ³•ï¼ˆè¼ªç›¤è³­ï¼‰

```java
private Prize selectPrizeByProbability(List<Prize> prizes) {
    double random = Math.random();  // ç”Ÿæˆ [0, 1) éš¨æ©Ÿæ•¸
    double cumulativeProbability = 0.0;
    
    for (Prize prize : prizes) {
        cumulativeProbability += prize.getProbability().doubleValue();
        if (random <= cumulativeProbability) {
            return prize;
        }
    }
    return prizes.get(prizes.size() - 1);  // è¿”å›æœ€å¾Œä¸€å€‹ï¼ˆé€šå¸¸æ˜¯éŠ˜è¬æƒ é¡§ï¼‰
}
```

### ä¸¦ç™¼æ§åˆ¶ï¼ˆä¸‰å±¤é˜²è­·ï¼‰

```
[ç¬¬ä¸€å±¤] Redis åˆ†ä½ˆå¼é– (Redisson)
  â””â”€ é˜²æ­¢åŒä¸€ç”¨æˆ¶ä½µç™¼é‡è¤‡æŠ½ç
  â””â”€ é–ç²’åº¦ï¼šuserId + activityId
  â””â”€ è¶…æ™‚è¨­ç½®ï¼šç­‰å¾… 10sï¼ŒæŒæœ‰ 30s

[ç¬¬äºŒå±¤] æ•¸æ“šåº«æ‚²è§€é–
  â””â”€ SELECT ... FOR UPDATE
  â””â”€ é˜²æ­¢çå“åº«å­˜è¶…æŠ½
  â””â”€ åŸå­æ€§æ“ä½œ

[ç¬¬ä¸‰å±¤] äº‹å‹™ç®¡ç†
  â””â”€ @Transactional
  â””â”€ ä»»ä½•ç•°å¸¸è‡ªå‹•å›æ»¾
  â””â”€ ä¿è­‰çµ±è¨ˆæ•¸æ“šä¸€è‡´æ€§
```

### é˜²è¶…æŠ½æ©Ÿåˆ¶

**å®Œæ•´æµç¨‹ï¼š**

1. æª¢æŸ¥ç”¨æˆ¶å‰©é¤˜æ¬¡æ•¸
2. ç²å–åˆ†ä½ˆå¼é–ï¼ˆRedissonï¼‰
3. æ ¹æ“šæ©Ÿç‡é¸æ“‡çå“
4. ä½¿ç”¨æ‚²è§€é–æŸ¥è©¢çå“
5. æª¢æŸ¥åº«å­˜æ˜¯å¦å……è¶³
6. åŸå­æ€§æ‰£æ¸›åº«å­˜
7. è¨˜éŒ„æŠ½ççµæœ
8. æ›´æ–°çµ±è¨ˆæ•¸æ“š
9. é‡‹æ”¾é–

---

## æ•¸æ“šåº«è¨­è¨ˆ

### æ ¸å¿ƒè¡¨çµæ§‹

#### users (ç”¨æˆ¶è¡¨)
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    role VARCHAR(20) NOT NULL DEFAULT 'USER',
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_username (username)
);
```

#### lottery_activities (æ´»å‹•è¡¨)
```sql
CREATE TABLE lottery_activities (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    limit_type VARCHAR(20) NOT NULL DEFAULT 'TOTAL',
    max_draws_per_user INT NOT NULL DEFAULT 1,
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_status (status),
    INDEX idx_time (start_time, end_time)
);
```

#### prizes (çå“è¡¨)
```sql
CREATE TABLE prizes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    activity_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    total_stock INT NOT NULL,
    remaining_stock INT NOT NULL,
    probability DECIMAL(10, 6) NOT NULL,
    prize_type VARCHAR(20) NOT NULL,
    image_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_activity FOREIGN KEY (activity_id) REFERENCES lottery_activities(id),
    CONSTRAINT chk_probability CHECK (probability >= 0 AND probability <= 1),
    CONSTRAINT chk_stock CHECK (remaining_stock >= 0),
    INDEX idx_activity (activity_id),
    INDEX idx_stock (remaining_stock)
);
```

#### draw_records (æŠ½çè¨˜éŒ„è¡¨)
```sql
CREATE TABLE draw_records (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    activity_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    prize_id BIGINT,
    is_winning BOOLEAN NOT NULL DEFAULT FALSE,
    prize_name VARCHAR(100),
    draw_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) NOT NULL DEFAULT 'COMPLETED',
    CONSTRAINT fk_activity FOREIGN KEY (activity_id) REFERENCES lottery_activities(id),
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id),
    CONSTRAINT fk_prize FOREIGN KEY (prize_id) REFERENCES prizes(id),
    INDEX idx_user_activity (user_id, activity_id),
    INDEX idx_activity_time (activity_id, draw_time)
);
```

#### user_draw_statistics (ç”¨æˆ¶çµ±è¨ˆè¡¨)
```sql
CREATE TABLE user_draw_statistics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    activity_id BIGINT NOT NULL,
    total_draws INT NOT NULL DEFAULT 0,
    winning_draws INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id),
    CONSTRAINT fk_activity FOREIGN KEY (activity_id) REFERENCES lottery_activities(id),
    UNIQUE KEY uk_user_activity (user_id, activity_id)
);
```

#### user_daily_draw_statistics (æ¯æ—¥çµ±è¨ˆè¡¨)
```sql
CREATE TABLE user_daily_draw_statistics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    activity_id BIGINT NOT NULL,
    draw_date DATE NOT NULL,
    daily_draws INT NOT NULL DEFAULT 0,
    daily_winning_draws INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id),
    CONSTRAINT fk_activity FOREIGN KEY (activity_id) REFERENCES lottery_activities(id),
    UNIQUE KEY uk_user_activity_date (user_id, activity_id, draw_date)
);
```

---

## é™æµç­–ç•¥

### é™æµè¨»è§£ (@RateLimit)

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    // æ¨™è¨˜éœ€è¦é™æµçš„æ–¹æ³•
}
```

### é™æµ AOP åˆ‡é¢

```java
@Aspect
@Component
public class RateLimitAspect {
    
    @Around("@annotation(rateLimit)")
    public Object rateLimit(ProceedingJoinPoint pjp, RateLimit rateLimit) 
            throws Throwable {
        // 1. ç²å–å…¨å±€é™æµå™¨
        // 2. æª¢æŸ¥æ˜¯å¦è¶…éé™æµ
        // 3. è‹¥è¶…éé™æµï¼Œæ‹‹å‡ºç•°å¸¸
        // 4. å¦å‰‡åŸ·è¡Œæ–¹æ³•
    }
}
```

### ä½¿ç”¨ç¤ºä¾‹

```java
@PostMapping("/draw")
@RateLimit  // ä½¿ç”¨é™æµè¨»è§£
public ApiResponse<DrawResponse> draw(
        @Valid @RequestBody DrawRequest request,
        Authentication authentication) {
    // æ–¹æ³•åŸ·è¡Œæ™‚è‡ªå‹•é™æµæª¢æŸ¥
}
```

### é™æµé…ç½®

```yaml
# application.yml
rate-limiter:
  global:
    permits-per-second: 1000  # å…¨å±€é™æµï¼šæ¯ç§’ 1000 æ¬¡
  user:
    permits-per-second: 10    # ç”¨æˆ¶ç¶­åº¦ï¼šæ¯å€‹ç”¨æˆ¶æ¯ç§’ 10 æ¬¡
```

---

## æ¸¬è©¦

### é‹è¡Œæ¸¬è©¦

```bash
# é‹è¡Œæ‰€æœ‰æ¸¬è©¦
./gradlew test

# é‹è¡Œç‰¹å®šæ¸¬è©¦é¡
./gradlew test --tests LotteryServiceTest

# é‹è¡Œæ•´åˆæ¸¬è©¦
./gradlew test --tests LotteryServiceIntegrationTest
```

### æ¸¬è©¦ç”¨ä¾‹

#### å–®å…ƒæ¸¬è©¦ (LotteryServiceTest)

âœ… **testSingleDrawSuccess** - å–®æ¬¡æŠ½çæˆåŠŸ  
âœ… **testMultipleDraws** - å¤šæ¬¡é€£çºŒæŠ½ç  
âœ… **testInsufficientDraws** - æŠ½çæ¬¡æ•¸ä¸è¶³  
âœ… **testActivityNotFound** - æ´»å‹•ä¸å­˜åœ¨  
âœ… **testActivityEnded** - æ´»å‹•å·²çµæŸ  
âœ… **testPrizeStockDeduction** - çå“åº«å­˜æ‰£æ¸›  
âœ… **testProbabilityDistribution** - æ©Ÿç‡åˆ†å¸ƒé©—è­‰ï¼ˆ1000 æ¬¡ï¼‰  
âœ… **testDailyLimitMode** - æ¯æ—¥é™åˆ¶æ¨¡å¼  
âœ… **testTotalLimitMode** - ç¸½æ¬¡æ•¸é™åˆ¶æ¨¡å¼

#### æ•´åˆæ¸¬è©¦ (LotteryServiceIntegrationTest)

âœ… **testDailyLimitExceeded** - æ¯æ—¥é™åˆ¶è¶…å‡º  
âœ… **testTotalLimitExceeded** - ç¸½æ¬¡æ•¸é™åˆ¶è¶…å‡º  
âœ… **testRateLimitExceeded** - é™æµæ¸¬è©¦  
âœ… **testConcurrentDrawSafety** - 10 ç·šç¨‹ä¸¦ç™¼å®‰å…¨æ€§  
âœ… **testActivityEnded** - æ´»å‹•çµæŸåˆ¤æ–·
